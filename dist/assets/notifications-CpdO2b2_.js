import{setLogLevel as e,initializeApp as t}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";import{getFirestore as o}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";import{getAuth as n,GoogleAuthProvider as a,signOut as r,signInWithPopup as s,signInWithRedirect as i,createUserWithEmailAndPassword as d,signInWithEmailAndPassword as l,setPersistence as c,browserLocalPersistence as g,getRedirectResult as u,onAuthStateChanged as h}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";import{getStorage as m}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const o of e)if("childList"===o.type)for(const e of o.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}(),e("error");const p={apiKey:"AIzaSyAfydxW2angrEgZ7TT2PJxv7RGGUUiGbW4",authDomain:"japan-itin-dev.firebaseapp.com",projectId:"japan-itin-dev",storageBucket:"japan-itin-dev.firebasestorage.app",messagingSenderId:"545081226259",appId:"1:545081226259:web:d06fd9962e05d42d40fbe6",measurementId:"G-DJ00DQ3MC8"};let f=null,b=null,w=null,E=null;p&&p.apiKey?(f=t(p),b=o(f),w=n(f),m(f),E=new a,console.log("üî• Firebase initialized for project:",p.projectId||"(unknown)")):console.warn("‚ö†Ô∏è Firebase not initialized because configuration is missing or incomplete.");const y=Object.freeze(Object.defineProperty({__proto__:null,get app(){return f},get auth(){return w},get db(){return b},get googleProvider(){return E}},Symbol.toStringTag,{value:"Module"})),v=new CustomEvent("auth:loggedOut"),L={currentUser:null,authUnsubscribe:null,showAuthLoading(e="Verificando autenticaci√≥n..."){const t=document.getElementById("landingPage"),o=document.getElementById("appDashboard");t&&t.classList.add("hidden"),o&&o.classList.add("hidden");let n=document.getElementById("authLoadingScreen");if(n){n.classList.remove("hidden");const t=document.getElementById("authLoadingMessage");t&&(t.textContent=e)}else n=document.createElement("div"),n.id="authLoadingScreen",n.className="fixed inset-0 bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center z-50",n.innerHTML=`\n        <div class="text-center text-white">\n          <div class="mb-6">\n            <div class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-white border-t-transparent"></div>\n          </div>\n          <h2 class="text-2xl font-bold mb-2" id="authLoadingMessage">${e}</h2>\n          <p class="text-white/80 text-sm">Por favor espera...</p>\n        </div>\n      `,document.body.appendChild(n)},hideAuthLoading(){const e=document.getElementById("authLoadingScreen");e&&e.classList.add("hidden")},async init(){console.log("üîê Inicializando autenticaci√≥n (versi√≥n robusta)..."),this.showAuthLoading("Iniciando...");try{await c(w,g),console.log("‚úÖ Persistencia configurada correctamente.")}catch(e){console.error("‚ùå Error configurando persistence:",e)}return"loading"===document.readyState&&await new Promise(e=>document.addEventListener("DOMContentLoaded",e)),this.setupLandingPage(),new Promise(async e=>{let t=!1;try{this.showAuthLoading("Procesando inicio de sesi√≥n..."),console.log("üì• Verificando resultado de redirecci√≥n de Google...");const e=await u(w);e&&e.user?(console.log("‚úÖ Usuario autenticado por redirecci√≥n:",e.user.displayName||e.user.email),this.currentUser=e.user,t=!0,console.log("‚úÖ Redirecci√≥n procesada exitosamente, esperando onAuthStateChanged...")):console.log("‚ÑπÔ∏è No hay resultado de redirecci√≥n pendiente.")}catch(n){console.error("üõë Error procesando el resultado de la redirecci√≥n:",n),this.handleAuthError(n)}let o=!0;this.authUnsubscribe=h(w,n=>{console.log("üîî onAuthStateChanged triggered. User:",n?n.email:"null","First call:",o,"Redirect handled:",t),n?(console.log(`‚úÖ Sesi√≥n activa encontrada para: ${n.displayName||n.email}`),this.currentUser=n,this.showAppDashboard(),this.updateUserInfo(this.currentUser),console.log("üöÄ Disparando evento auth:initialized"),window.dispatchEvent((e=>new CustomEvent("auth:initialized",{detail:{user:e}}))(this.currentUser))):(console.log("üö´ No hay sesi√≥n activa. Mostrando landing page."),this.showLandingPage()),o&&(o=!1,console.log("‚úÖ Promesa de auth resuelta"),e(this.currentUser))})})},setupLandingPage(){console.log("üé® Setup de landing page");const e=document.getElementById("loginTabBtn"),t=document.getElementById("registerTabBtn"),o=document.getElementById("landingLoginForm"),n=document.getElementById("landingRegisterForm");e&&t&&o&&n?(e.addEventListener("click",()=>{e.className="auth-tab-btn flex-1 px-4 py-2 font-semibold border-b-2 border-blue-500 text-blue-600 dark:text-blue-400",t.className="auth-tab-btn flex-1 px-4 py-2 font-semibold border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300",o.classList.remove("hidden"),n.classList.add("hidden")}),t.addEventListener("click",()=>{t.className="auth-tab-btn flex-1 px-4 py-2 font-semibold border-b-2 border-green-500 text-green-600 dark:text-green-400",e.className="auth-tab-btn flex-1 px-4 py-2 font-semibold border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300",n.classList.remove("hidden"),o.classList.add("hidden")}),o.addEventListener("submit",e=>{e.preventDefault(),this.handleLandingLogin()}),n.addEventListener("submit",e=>{e.preventDefault(),this.handleLandingRegister()}),console.log("‚úÖ Event listeners de login/register agregados")):console.warn("‚ö†Ô∏è Elementos de landing page no encontrados");const a=document.getElementById("landingGoogleLogin");a?(a.addEventListener("click",()=>{console.log("üîò Click en Google login"),this.loginWithGoogle()}),console.log("‚úÖ Event listener de Google agregado")):console.warn("‚ö†Ô∏è Bot√≥n de Google no encontrado");const r=document.getElementById("logoutBtn");r&&(r.addEventListener("click",()=>{console.log("üîò Click en logout"),this.logout()}),console.log("‚úÖ Event listener de logout agregado"))},async handleLandingLogin(){const e=document.getElementById("landingLoginEmail").value,t=document.getElementById("landingLoginPassword").value;if(e&&t){console.log("üìß Intentando login con:",e),this.showAuthLoading("Iniciando sesi√≥n...");try{const o=await l(w,e,t);console.log("‚úÖ Login exitoso con email/password:",o.user.email),console.log("üîÑ Esperando que onAuthStateChanged detecte el cambio...")}catch(o){console.error("‚ùå Error en login:",o),this.hideAuthLoading(),this.handleAuthError(o)}}else this.showError("Por favor ingresa tu email y contrase√±a")},async handleLandingRegister(){const e=document.getElementById("landingRegisterEmail").value,t=document.getElementById("landingRegisterPassword").value,o=document.getElementById("landingRegisterConfirmPassword").value;if(e&&t&&o)if(t===o)if(t.length<6)this.showError("La contrase√±a debe tener al menos 6 caracteres");else{console.log("üìß Intentando registro con:",e),this.showAuthLoading("Creando cuenta...");try{const o=await d(w,e,t);console.log("‚úÖ Registro exitoso:",o.user.email),console.log("üîÑ Esperando que onAuthStateChanged detecte el cambio...")}catch(n){console.error("‚ùå Error en registro:",n),this.hideAuthLoading(),this.handleAuthError(n)}}else this.showError("Las contrase√±as no coinciden");else this.showError("Por favor completa todos los campos")},async loginWithGoogle(){console.log("üîë Iniciando login con Google..."),this.showAuthLoading("Abriendo ventana de Google...");try{const e=await s(w,E);console.log("‚úÖ Login con Google exitoso:",e.user.email)}catch(e){if(console.error("‚ùå Error al iniciar login con Google:",e),this.hideAuthLoading(),"auth/popup-blocked"===e.code){this.showError("El popup fue bloqueado. Intentando con redirecci√≥n...","info");try{await i(w,E)}catch(t){console.error("‚ùå Error en redirect fallback:",t),this.handleAuthError(t)}}else this.handleAuthError(e)}},async logout(){try{await r(w),this.currentUser=null,console.log("‚úÖ Sesi√≥n cerrada"),window.dispatchEvent(v)}catch(e){console.error("‚ùå Error al cerrar sesi√≥n:",e),this.showError("Error al cerrar sesi√≥n")}},showLandingPage(){this.hideAuthLoading();const e=document.getElementById("landingPage"),t=document.getElementById("appDashboard");e&&(e.classList.remove("hidden"),console.log("üëã Landing page mostrada")),t&&(t.classList.add("hidden"),console.log("üì± Dashboard ocultado"))},showAppDashboard(){this.hideAuthLoading();const e=document.getElementById("landingPage"),t=document.getElementById("appDashboard");e&&(e.classList.add("hidden"),console.log("üëã Landing page ocultada")),t&&(t.classList.remove("hidden"),console.log("üì± Dashboard mostrado"))},updateUserInfo(e){const t=document.getElementById("userEmailDisplay");t&&e&&(t.textContent=e.email)},showError(e,t="error"){window.Notifications&&window.Notifications[t]?window.Notifications[t](e):alert(`‚ö†Ô∏è ${e}`)},handleAuthError(e){let t="Error en autenticaci√≥n";switch(e.code){case"auth/invalid-email":t="‚ö†Ô∏è Email inv√°lido";break;case"auth/user-not-found":t="‚ö†Ô∏è No existe cuenta con este email";break;case"auth/wrong-password":t="‚ö†Ô∏è Contrase√±a incorrecta";break;case"auth/email-already-in-use":t="‚ö†Ô∏è Este email ya est√° registrado";break;case"auth/weak-password":t="‚ö†Ô∏è La contrase√±a es muy d√©bil (m√≠nimo 6 caracteres)";break;case"auth/invalid-credential":t="‚ö†Ô∏è Email o contrase√±a incorrectos";break;default:t=`‚ö†Ô∏è Error: ${e.message}`}this.showError(t)}};window.AuthHandler=L;const x={container:null,init(){this.container=document.getElementById("toastContainer"),this.container||(this.container=document.createElement("div"),this.container.id="toastContainer",this.container.className="toast-container",document.body.appendChild(this.container))},show(e,t="info",o=4e3,n=null){this.init();const a=document.createElement("div");a.className=`toast toast-${t}`;const r=n||{success:"¬°√âxito!",error:"Error",warning:"Advertencia",info:"Informaci√≥n"}[t];a.innerHTML=`\n      <div class="toast-icon">${{success:'<i class="fas fa-check-circle"></i>',error:'<i class="fas fa-exclamation-circle"></i>',warning:'<i class="fas fa-exclamation-triangle"></i>',info:'<i class="fas fa-info-circle"></i>'}[t]}</div>\n      <div class="toast-content">\n        <div class="toast-title">${r}</div>\n        <div class="toast-message">${e}</div>\n      </div>\n      <button class="toast-close" aria-label="Cerrar">&times;</button>\n    `;return a.querySelector(".toast-close").addEventListener("click",()=>{this.removeToast(a)}),this.container.appendChild(a),o>0&&setTimeout(()=>{this.removeToast(a)},o),a},removeToast(e){e.style.animation="toastSlideIn 0.3s ease-out reverse",setTimeout(()=>{e.parentElement&&e.remove()},300)},success(e,t){return this.show(e,"success",t)},error(e,t){return this.show(e,"error",t)},warning(e,t){return this.show(e,"warning",t)},info(e,t){return this.show(e,"info",t)}};window.Notifications=x;export{L as A,x as N,w as a,b as d,y as f};
