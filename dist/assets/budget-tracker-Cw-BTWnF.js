import{a as e,d as t}from"./notifications-UIywheBc.js";import{deleteDoc as s,doc as n,addDoc as r,collection as o,query as a,orderBy as i,onSnapshot as d}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";import"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";import"https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";const l={expenses:[],unsubscribe:null,getCurrentTripId:()=>window.TripsManager&&window.TripsManager.currentTrip?window.TripsManager.currentTrip.id:localStorage.getItem("currentTripId"),initRealtimeSync(){if(this.unsubscribe&&this.unsubscribe(),!e.currentUser)return this.expenses=JSON.parse(localStorage.getItem("expenses")||"[]"),void this.updateModal();const s=this.getCurrentTripId(),n=e.currentUser.uid;if(!s){console.log("⚠️ Budget: No hay trip seleccionado, usando modo individual");const e=o(t,`users/${n}/expenses`),s=a(e,i("timestamp","desc"));return void(this.unsubscribe=d(s,e=>{this.expenses=[],e.forEach(e=>{this.expenses.push({id:e.id,...e.data()})}),localStorage.setItem("expenses",JSON.stringify(this.expenses)),this.updateModal(),console.log("✅ Gastos (individual) sincronizados:",this.expenses.length)},e=>{console.error("❌ Error en sync de gastos:",e),this.expenses=JSON.parse(localStorage.getItem("expenses")||"[]"),this.updateModal()}))}console.log("🤝 Budget: Modo colaborativo activado para trip:",s);const r=o(t,`trips/${s}/expenses`),l=a(r,i("timestamp","desc"));this.unsubscribe=d(l,e=>{this.expenses=[],e.forEach(e=>{this.expenses.push({id:e.id,...e.data()})}),localStorage.setItem("expenses",JSON.stringify(this.expenses)),this.updateModal(),console.log("✅ Gastos COMPARTIDOS sincronizados:",this.expenses.length,"gastos")},e=>{console.error("❌ Error en sync de gastos compartidos:",e),this.expenses=JSON.parse(localStorage.getItem("expenses")||"[]"),this.updateModal()})},updateModal(){const t=document.getElementById("budgetModalContent");if(!t)return;const s=this.expenses.reduce((e,t)=>e+t.amount,0),n=this.getCurrentTripId(),r=this.expenses.reduce((e,t)=>{const s=t.category||"Otros";return e[s]=(e[s]||0)+t.amount,e},{}),o=Object.entries(r).sort((e,t)=>t[1]-e[1]);let a;a=e.currentUser?n?'<span class="text-green-600 dark:text-green-400">🤝 Modo Colaborativo</span>':'<span class="text-blue-600 dark:text-blue-400">☁️ Sincronizado</span>':'<span class="text-yellow-600 dark:text-yellow-400">📱 Solo local</span>',t.innerHTML=`\n      \x3c!-- Total Card con mejor diseño --\x3e\n      <div class="mb-6 p-6 bg-gradient-to-br from-emerald-500 via-green-500 to-teal-500 text-white rounded-2xl shadow-xl">\n        <div class="flex justify-between items-center mb-3">\n          <p class="text-sm opacity-90">Total Gastado</p>\n          <p class="text-xs opacity-90">${a}</p>\n        </div>\n        <p class="text-4xl font-black mb-2">¥${s.toLocaleString()}</p>\n        <div class="flex justify-between items-center text-sm opacity-90">\n          <span>~$${Math.round(s/145)} USD</span>\n          <span>${this.expenses.length} gastos</span>\n        </div>\n      </div>\n\n      \x3c!-- Gráfico de Categorías --\x3e\n      ${o.length>0?`\n        <div class="mb-6 p-4 bg-white dark:bg-gray-800 rounded-xl shadow-lg">\n          <h3 class="font-bold text-lg mb-4 dark:text-white">📊 Por Categoría</h3>\n          <div class="space-y-3">\n            ${o.map(([e,t])=>{const n=(t/s*100).toFixed(1),r=this.getCategoryIcon(e),o=this.getCategoryColor(e);return`\n                <div>\n                  <div class="flex justify-between text-sm mb-1">\n                    <span class="dark:text-white">${r} ${e}</span>\n                    <span class="font-semibold dark:text-white">¥${t.toLocaleString()} (${n}%)</span>\n                  </div>\n                  <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">\n                    <div class="${o} h-2.5 rounded-full transition-all duration-500" style="width: ${n}%"></div>\n                  </div>\n                </div>\n              `}).join("")}\n          </div>\n        </div>\n      `:""}\n\n      \x3c!-- Formulario de Agregar --\x3e\n      <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-xl">\n        <h3 class="font-bold mb-3 dark:text-white">➕ Agregar Gasto</h3>\n        <div class="grid grid-cols-2 gap-2 mb-2">\n          <input id="expenseDesc" type="text" class="col-span-2 p-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-transparent transition" placeholder="Descripción (ej. Sushi en Shibuya)">\n          <select id="expenseCategory" class="p-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-transparent">\n            <option value="Comida">🍜 Comida</option>\n            <option value="Transporte">🚇 Transporte</option>\n            <option value="Alojamiento">🏨 Alojamiento</option>\n            <option value="Entretenimiento">🎮 Entretenimiento</option>\n            <option value="Compras">🛍️ Compras</option>\n            <option value="Otros">📦 Otros</option>\n          </select>\n          <input id="expenseAmount" type="number" class="p-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="¥ JPY">\n        </div>\n        <button id="addExpenseBtn" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 rounded-lg transition transform hover:scale-105 shadow-lg">\n          ➕ Agregar Gasto\n        </button>\n      </div>\n\n      \x3c!-- Lista de Gastos --\x3e\n      <div class="space-y-2 max-h-96 overflow-y-auto">\n        ${0===this.expenses.length?'\n          <div class="text-center py-12">\n            <div class="text-6xl mb-3">💰</div>\n            <p class="text-gray-500 dark:text-gray-400 font-semibold">No hay gastos registrados</p>\n            <p class="text-sm text-gray-400 dark:text-gray-500">¡Agrega tu primer gasto arriba!</p>\n          </div>\n        ':this.expenses.map(e=>{const t=this.getCategoryIcon(e.category||"Otros");return`\n            <div class="group p-3 bg-white dark:bg-gray-700 rounded-lg border-l-4 ${this.getCategoryColorClass(e.category||"Otros")} hover:shadow-md transition-all">\n              <div class="flex justify-between items-start">\n                <div class="flex-1">\n                  <div class="flex items-center gap-2 mb-1">\n                    <span class="text-lg">${t}</span>\n                    <span class="dark:text-white font-semibold">${this.escapeHtml(e.desc)}</span>\n                  </div>\n                  <div class="flex gap-3 text-xs text-gray-500 dark:text-gray-400">\n                    ${e.category?`<span>📁 ${e.category}</span>`:""}\n                    ${e.addedBy?`<span>👤 ${e.addedBy.split("@")[0]}</span>`:""}\n                    ${e.date?`<span>📅 ${new Date(e.date).toLocaleDateString("es")}</span>`:""}\n                  </div>\n                </div>\n                <div class="flex items-center gap-3">\n                  <span class="text-green-600 dark:text-green-400 font-bold text-lg">¥${e.amount.toLocaleString()}</span>\n                  <button data-expense-id="${e.id||e.timestamp}" class="delete-expense opacity-0 group-hover:opacity-100 text-red-600 hover:text-red-700 transition-all transform hover:scale-110">\n                    🗑️\n                  </button>\n                </div>\n              </div>\n            </div>\n          `}).join("")}\n      </div>\n    `;const i=document.getElementById("addExpenseBtn");i&&i.addEventListener("click",()=>this.addExpense());const d=document.getElementById("expenseDesc"),l=document.getElementById("expenseAmount");d&&d.addEventListener("keypress",e=>{"Enter"===e.key&&this.addExpense()}),l&&l.addEventListener("keypress",e=>{"Enter"===e.key&&this.addExpense()}),t.querySelectorAll(".delete-expense").forEach(e=>{e.addEventListener("click",e=>{const t=e.currentTarget.dataset.expenseId;this.deleteExpense(t)})})},async addExpense(){const s=document.getElementById("expenseDesc"),n=document.getElementById("expenseAmount"),a=document.getElementById("expenseCategory");if(!s||!n)return;const i=s.value.trim(),d=parseFloat(n.value),l=a?a.value:"Otros";if(!i||!d||d<=0)return void window.Notifications.warning("⚠️ Por favor completa la descripción y monto");const c={desc:i,amount:d,category:l,timestamp:Date.now(),date:(new Date).toISOString(),addedBy:e.currentUser?e.currentUser.email:"Usuario local"};try{if(!e.currentUser)return this.expenses.push(c),localStorage.setItem("expenses",JSON.stringify(this.expenses)),this.updateModal(),console.log("📱 Gasto guardado localmente"),s.value="",n.value="",void s.focus();const a=this.getCurrentTripId();if(a)await r(o(t,`trips/${a}/expenses`),c),console.log("✅ Gasto guardado (COMPARTIDO) en Firebase por:",c.addedBy);else{const s=e.currentUser.uid;await r(o(t,`users/${s}/expenses`),c),console.log("✅ Gasto guardado (individual) en Firebase")}s.value="",n.value="",s.focus()}catch(p){console.error("❌ Error guardando gasto:",p),window.Notifications.error("Error al guardar. Intenta de nuevo.")}},async deleteExpense(r){if(await window.Dialogs.confirm({title:"🗑️ ¿Eliminar Gasto?",message:"¿Estás seguro de que deseas eliminar este gasto?",okText:"Sí, eliminar",isDestructive:!0}))try{if(!e.currentUser)return this.expenses=this.expenses.filter(e=>(e.id||e.timestamp.toString())!==r.toString()),localStorage.setItem("expenses",JSON.stringify(this.expenses)),this.updateModal(),void console.log("📱 Gasto eliminado localmente");const o=this.getCurrentTripId();if(o)await s(n(t,`trips/${o}/expenses`,r)),console.log("✅ Gasto eliminado (COMPARTIDO) de Firebase");else{const o=e.currentUser.uid;await s(n(t,`users/${o}/expenses`,r)),console.log("✅ Gasto eliminado (individual) de Firebase")}}catch(o){console.error("❌ Error eliminando gasto:",o),window.Notifications.error("Error al eliminar. Intenta de nuevo.")}},escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML},getCategoryIcon:e=>({Comida:"🍜",Transporte:"🚇",Alojamiento:"🏨",Entretenimiento:"🎮",Compras:"🛍️",Otros:"📦"}[e]||"📦"),getCategoryColor(e){const t={Comida:"bg-gradient-to-r from-orange-400 to-red-500",Transporte:"bg-gradient-to-r from-blue-400 to-cyan-500",Alojamiento:"bg-gradient-to-r from-purple-400 to-pink-500",Entretenimiento:"bg-gradient-to-r from-green-400 to-emerald-500",Compras:"bg-gradient-to-r from-yellow-400 to-amber-500",Otros:"bg-gradient-to-r from-gray-400 to-slate-500"};return t[e]||t.Otros},getCategoryColorClass(e){const t={Comida:"border-orange-500",Transporte:"border-blue-500",Alojamiento:"border-purple-500",Entretenimiento:"border-green-500",Compras:"border-yellow-500",Otros:"border-gray-500"};return t[e]||t.Otros},cleanup(){this.unsubscribe&&(console.log("[BudgetTracker] 🛑 Deteniendo listener de gastos."),this.unsubscribe(),this.unsubscribe=null),this.expenses=[],localStorage.removeItem("expenses"),this.updateModal(),console.log("[BudgetTracker] 🧹 Estado de gastos limpiado.")},reinitialize(){this.initRealtimeSync()}};window.BudgetTracker=l,window.addEventListener("auth:initialized",e=>{console.log("[BudgetTracker] ✨ Evento auth:initialized recibido. Inicializando sync de gastos..."),l.initRealtimeSync()}),window.addEventListener("auth:loggedOut",()=>{console.log("[BudgetTracker] 🚫 Evento auth:loggedOut recibido. Limpiando..."),l.cleanup()});export{l as BudgetTracker};
