name: Generate config files for deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  generate-configs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate js/config.js from secret
        if: ${{ secrets.CONFIG_GOOGLE_PLACES_KEY }}
        run: |
          echo "// Generated file - DO NOT COMMIT" > js/config.js
          echo "export const APP_CONFIG = {" >> js/config.js
          echo "  GOOGLE_PLACES_API_KEY: '${{ secrets.CONFIG_GOOGLE_PLACES_KEY }}'" >> js/config.js
          echo "};" >> js/config.js

      - name: Generate js/firebase-config.js from secret
        if: ${{ secrets.FIREBASE_CONFIG_JSON }}
        run: |
          cat > js/firebase-config.js <<'EOF'
          // Generated file - DO NOT COMMIT
          // This file is an ES module that initializes Firebase using the secret provided by CI.
          import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
          import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
          import { getAuth, GoogleAuthProvider } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
          import { getStorage } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

          // Injected config (from GitHub Secrets)
          const firebaseConfig = ${{ secrets.FIREBASE_CONFIG_JSON }};

          let app = null;
          let db = null;
          let auth = null;
          let storage = null;
          let googleProvider = null;

          if (firebaseConfig && firebaseConfig.apiKey) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            storage = getStorage(app);
            googleProvider = new GoogleAuthProvider();
            console.log('🔥 Firebase initialized for project:', firebaseConfig.projectId || '(unknown)');
          } else {
            console.warn('⚠️ Firebase not initialized because configuration is missing or incomplete.');
          }

          export { app, db, auth, storage, googleProvider };
          EOF

      - name: Generate js/apis-config.js from secret
        if: ${{ secrets.API_KEYS_JSON }}
        run: |
          echo "// Generated file - DO NOT COMMIT" > js/apis-config.js
          echo "window.RUNTIME_API_KEYS = ${{ secrets.API_KEYS_JSON }};" >> js/apis-config.js

      - name: Show created files
        run: |
          ls -la js || true
          sed -n '1,120p' js/config.js || true
          sed -n '1,120p' js/firebase-config.js || true
