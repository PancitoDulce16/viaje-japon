// js/auth.js - Sistema de Autenticaci√≥n con Landing Page

import { auth, googleProvider } from './firebase-config.js';
import { 
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  signInWithPopup,
  signOut,
  onAuthStateChanged
} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

export const AuthHandler = {
  currentUser: null,

  init() {
    console.log('üîê Inicializando autenticaci√≥n...');
    
    // Esperar a que el DOM est√© completamente cargado
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        this.setupLandingPage();
      });
    } else {
      this.setupLandingPage();
    }
    
    // Listener de cambios de autenticaci√≥n
    onAuthStateChanged(auth, (user) => {
      this.currentUser = user;
      
      if (user) {
        console.log('‚úÖ Usuario autenticado:', user.email);
        this.showAppDashboard();
        this.updateUserInfo(user);
      } else {
        console.log('‚ö†Ô∏è No hay usuario autenticado');
        this.showLandingPage();
      }
    });
  },

  // Setup de la landing page
  setupLandingPage() {
    console.log('üé® Setup de landing page');
    
    // Tabs de Login/Register
    const loginTabBtn = document.getElementById('loginTabBtn');
    const registerTabBtn = document.getElementById('registerTabBtn');
    const loginForm = document.getElementById('landingLoginForm');
    const registerForm = document.getElementById('landingRegisterForm');

    if (loginTabBtn && registerTabBtn && loginForm && registerForm) {
      loginTabBtn.addEventListener('click', () => {
        loginTabBtn.className = 'auth-tab-btn flex-1 px-4 py-2 font-semibold border-b-2 border-blue-500 text-blue-600 dark:text-blue-400';
        registerTabBtn.className = 'auth-tab-btn flex-1 px-4 py-2 font-semibold border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300';
        
        loginForm.classList.remove('hidden');
        registerForm.classList.add('hidden');
      });

      registerTabBtn.addEventListener('click', () => {
        registerTabBtn.className = 'auth-tab-btn flex-1 px-4 py-2 font-semibold border-b-2 border-green-500 text-green-600 dark:text-green-400';
        loginTabBtn.className = 'auth-tab-btn flex-1 px-4 py-2 font-semibold border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300';
        
        registerForm.classList.remove('hidden');
        loginForm.classList.add('hidden');
      });

      // Login form
      loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        this.handleLandingLogin();
      });

      // Register form
      registerForm.addEventListener('submit', (e) => {
        e.preventDefault();
        this.handleLandingRegister();
      });

      console.log('‚úÖ Event listeners de login/register agregados');
    } else {
      console.warn('‚ö†Ô∏è Elementos de landing page no encontrados');
    }

    // Google login button
    const googleBtn = document.getElementById('landingGoogleLogin');
    if (googleBtn) {
      googleBtn.addEventListener('click', () => {
        console.log('üîò Click en Google login');
        this.loginWithGoogle();
      });
      console.log('‚úÖ Event listener de Google agregado');
    } else {
      console.warn('‚ö†Ô∏è Bot√≥n de Google no encontrado');
    }

    // Logout button (para cuando est√© en dashboard)
    setTimeout(() => {
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
          console.log('üîò Click en logout');
          this.logout();
        });
        console.log('‚úÖ Event listener de logout agregado');
      }
    }, 500);
  },

  // Login desde landing page
  async handleLandingLogin() {
    const email = document.getElementById('landingLoginEmail').value;
    const password = document.getElementById('landingLoginPassword').value;

    console.log('üìß Intentando login con:', email);

    try {
      await signInWithEmailAndPassword(auth, email, password);
      console.log('‚úÖ Login exitoso');
    } catch (error) {
      console.error('‚ùå Error en login:', error);
      this.handleAuthError(error);
    }
  },

  // Registro desde landing page
  async handleLandingRegister() {
    const email = document.getElementById('landingRegisterEmail').value;
    const password = document.getElementById('landingRegisterPassword').value;
    const confirmPassword = document.getElementById('landingRegisterConfirmPassword').value;

    if (password !== confirmPassword) {
      alert('‚ö†Ô∏è Las contrase√±as no coinciden');
      return;
    }

    console.log('üìß Intentando registro con:', email);

    try {
      await createUserWithEmailAndPassword(auth, email, password);
      console.log('‚úÖ Registro exitoso');
      alert('‚úÖ Cuenta creada exitosamente!');
    } catch (error) {
      console.error('‚ùå Error en registro:', error);
      this.handleAuthError(error);
    }
  },

  // Login con Google
  async loginWithGoogle() {
    console.log('üîë Intentando login con Google...');
    
    try {
      const result = await signInWithPopup(auth, googleProvider);
      console.log('‚úÖ Login con Google exitoso:', result.user.email);
    } catch (error) {
      console.error('‚ùå Error en login con Google:', error);
      this.handleAuthError(error);
    }
  },

  // Logout
  async logout() {
    try {
      await signOut(auth);
      console.log('‚úÖ Sesi√≥n cerrada');
    } catch (error) {
      console.error('‚ùå Error al cerrar sesi√≥n:', error);
      alert('Error al cerrar sesi√≥n');
    }
  },

  // Mostrar landing page
  showLandingPage() {
    const landingPage = document.getElementById('landingPage');
    const appDashboard = document.getElementById('appDashboard');
    
    if (landingPage) {
      landingPage.classList.remove('hidden');
      console.log('üëã Landing page mostrada');
    }
    if (appDashboard) {
      appDashboard.classList.add('hidden');
      console.log('üì± Dashboard ocultado');
    }
  },

  // Mostrar dashboard de la app
  showAppDashboard() {
    const landingPage = document.getElementById('landingPage');
    const appDashboard = document.getElementById('appDashboard');
    
    if (landingPage) {
      landingPage.classList.add('hidden');
      console.log('üëã Landing page ocultada');
    }
    if (appDashboard) {
      appDashboard.classList.remove('hidden');
      console.log('üì± Dashboard mostrado');
    }
  },

  // Actualizar info del usuario en el header
  updateUserInfo(user) {
    const userEmailDisplay = document.getElementById('userEmailDisplay');
    if (userEmailDisplay) {
      userEmailDisplay.textContent = user.email;
    }
  },

  // Manejo de errores de autenticaci√≥n
  handleAuthError(error) {
    let message = 'Error en autenticaci√≥n';
    
    switch (error.code) {
      case 'auth/invalid-email':
        message = '‚ö†Ô∏è Email inv√°lido';
        break;
      case 'auth/user-not-found':
        message = '‚ö†Ô∏è No existe cuenta con este email';
        break;
      case 'auth/wrong-password':
        message = '‚ö†Ô∏è Contrase√±a incorrecta';
        break;
      case 'auth/email-already-in-use':
        message = '‚ö†Ô∏è Este email ya est√° registrado';
        break;
      case 'auth/weak-password':
        message = '‚ö†Ô∏è La contrase√±a es muy d√©bil (m√≠nimo 6 caracteres)';
        break;
      case 'auth/popup-closed-by-user':
        message = 'Inicio de sesi√≥n cancelado';
        break;
      case 'auth/cancelled-popup-request':
        message = 'Popup cerrado';
        break;
      default:
        message = `‚ö†Ô∏è Error: ${error.message}`;
    }
    
    alert(message);
  }
};

window.AuthHandler = AuthHandler;
